<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Low Barrel</title>
    <meta name="description" content="A collection of components that make it easy to build interactive charts with D3.">

    <script src="http://localhost:8000/scripts.js"></script>

    <link rel="icon" type="image/png" href="http://localhost:8000/images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="http://localhost:8000/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="http://localhost:8000/images/favicon-96x96.png" sizes="96x96">
    <link rel="stylesheet" href="http://localhost:8000/styles.css" />
    <link rel="canonical" href="https://d3fc.io/examples/low-barrel/index.html" />
  </head>
  <body>
    <div class="content">

      <nav class="navbar navbar-inverse">
        <div class="container">
            <div class="navbar-header">
              <a href="http://localhost:8000/"><img class="navbar-logo" alt="d3fc" src="http://localhost:8000/images/logo.svg" /></a>
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav navbar-right">
                <li class=""><a href="http://localhost:8000/components/introduction/getting-started.html">Documentation</a></li>
                <li class=""><a href="http://localhost:8000/components/chart/cartesian.html">Components</a></li>
                <li class=""><a href="http://localhost:8000/components/series/candlestick.html">Financial</a></li>
                <li class=""><a href="http://localhost:8000/api/annotation-api.html">API</a></li>
                <li class="active"><a href="http://localhost:8000/examples">Examples</a></li>
                <li><a href="git+https://github.com/d3fc/d3fc.git">GitHub</a></li>
              </ul>
            </div>
        </div>
      </nav>

      
<div class="container example">
  <div class="row">
    <div class="col-sm-9 col-xs-12">
      <h1>
        Low Barrel
      </h1>
      <div class="codepen-link">
  <form action="https://codepen.io/pen/define" method="POST" target="_blank">
    <input type="text" name="data" hidden="true"
      value='{
        "html":"&lt;svg id&#x3D;\&quot;low-barrel\&quot;&gt;
\n  &lt;g layout-style&#x3D;\&quot;flex: 0.65; flexDirection: row\&quot;&gt;
\n    &lt;svg class&#x3D;\&quot;main\&quot; layout-style&#x3D;\&quot;flex: 1\&quot;&gt;&lt;/svg&gt;
\n    &lt;g layout-style&#x3D;\&quot;width: 20; justifyContent: center\&quot;&gt;
\n      &lt;g layout-style&#x3D;\&quot;height: 0\&quot;&gt;
\n        &lt;text text-anchor&#x3D;\&quot;middle\&quot; transform&#x3D;\&quot;rotate(90)\&quot;&gt;OHLC&lt;/text&gt;
\n      &lt;/g&gt;
\n    &lt;/g&gt;
\n  &lt;/g&gt;
\n  &lt;g layout-style&#x3D;\&quot;flex: 0.2; flexDirection: row\&quot;&gt;
\n    &lt;svg class&#x3D;\&quot;volume\&quot; layout-style&#x3D;\&quot;flex: 1\&quot;&gt;&lt;/svg&gt;
\n    &lt;g layout-style&#x3D;\&quot;width: 20; justifyContent: center\&quot;&gt;
\n      &lt;g layout-style&#x3D;\&quot;height: 0\&quot;&gt;
\n        &lt;text text-anchor&#x3D;\&quot;middle\&quot; transform&#x3D;\&quot;rotate(90)\&quot;&gt;Volume&lt;/text&gt;
\n      &lt;/g&gt;
\n    &lt;/g&gt;
\n  &lt;/g&gt;
\n  &lt;g layout-style&#x3D;\&quot;flex: 0.15; flexDirection: row\&quot;&gt;
\n    &lt;svg class&#x3D;\&quot;navigator\&quot; layout-style&#x3D;\&quot;flex: 1\&quot;&gt;&lt;/svg&gt;
\n    &lt;text layout-style&#x3D;\&quot;width: 20\&quot;&gt;&lt;/text&gt;
\n  &lt;/g&gt;
\n&lt;/svg&gt;
\n",
        "js": "/* global d3:false, fc:false */
\n(function(d3, fc, example) {
\n  \"use strict\";
\n
\n  var formatters = {
\n    date: d3.time.format(\"%A, %b %e, %Y\"),
\n    price: d3.format(\".2f\"),
\n    volume: d3.format(\"0,5p\")
\n  };
\n
\n  example.candlestickSeries = function() {
\n
\n    var base = fc.series.ohlcBase();
\n
\n    var candlestick = fc.svg.candlestick()
\n            .x(function(d) { return d.x; })
\n            .open(function(d) { return d.yOpen; })
\n            .high(function(d) { return d.yHigh; })
\n            .low(function(d) { return d.yLow; })
\n            .close(function(d) { return d.yClose; });
\n
\n    var nest = d3.nest()
\n            .key(function(d) { return d.direction; });
\n
\n    var dataJoin = fc.util.dataJoin()
\n            .selector(\"path\")
\n            .element(\"path\");
\n
\n    function candlestickSeries(selection) {
\n      selection.each(function(data) {
\n        data = data.filter(base.defined);
\n
\n        candlestick.width(base.width(data));
\n
\n        dataJoin(this, nest.entries(data.map(base.values)))
\n                    .attr({
\n                      \"d\": function(d) {
\n                        return candlestick(d.values);
\n                      },
\n                      \"class\": function(d) {
\n                        return \"candlestick \" + d.key;
\n                      }
\n                    });
\n      });
\n    }
\n
\n    d3.rebind(candlestickSeries, base, \"xScale\", \"yScale\", \"xValue\", \"yValue\");
\n
\n    return candlestickSeries;
\n  };
\n
\n  example.mainChart = function() {
\n
\n    var event = d3.dispatch(\"crosshair\", \"zoom\");
\n
\n    var gridlines = fc.annotation.gridline()
\n            .yTicks(3);
\n
\n    var candlestick = example.candlestickSeries();
\n
\n    var tooltip = fc.chart.tooltip()
\n            .items([
\n                [function(d) { return formatters.date(d.datum.date); }, \"\"],
\n                [\"High:\", function(d) { return formatters.price(d.datum.high); }],
\n                [\"Low:\", function(d) { return formatters.price(d.datum.low); }],
\n                [\"Open:\", function(d) { return formatters.price(d.datum.open); }],
\n                [\"Close:\", function(d) { return formatters.price(d.datum.close); }],
\n                [\"Volume:\", function(d) { return formatters.volume(d.datum.volume); }]
\n            ]);
\n
\n    var tooltipContainer = fc.tool.container()
\n            .padding(5)
\n            .component(tooltip);
\n
\n    var tooltipLayout = fc.layout.label(fc.layout.strategy.boundingBox())
\n            .size([150, 104])
\n            .component(tooltipContainer);
\n
\n    var crosshairs = fc.tool.crosshair()
\n            .xLabel(\"\")
\n            .yLabel(\"\");
\n
\n    var multi = fc.series.multi()
\n            .series([gridlines, candlestick, tooltipLayout, crosshairs])
\n            .mapping(function(series) {
\n              switch (series) {
\n              case crosshairs:
\n              case tooltipLayout:
\n                return this.crosshairs;
\n              default:
\n                return this;
\n              }
\n            });
\n
\n    var xScale = fc.scale.dateTime();
\n
\n    var chart = fc.chart.cartesian(xScale)
\n            .margin({
\n              bottom: 20,
\n              right: 60
\n            })
\n            .xTicks(0)
\n            .yTicks(3)
\n            .plotArea(multi);
\n
\n    var pointer = fc.behavior.pointer();
\n
\n    function mainChart(selection) {
\n
\n      selection.each(function(data) {
\n        var snap = fc.util.seriesPointSnapXOnly(candlestick, data);
\n
\n        pointer.on(\"point\", function(points) {
\n          event.crosshair(points.map(snap));
\n        });
\n
\n        chart.xDomain(data.dateDomain)
\n                    .yDomain(fc.util.extent().fields([\"high\", \"low\"])(data))
\n                    .yNice();
\n
\n        var container = d3.select(this)
\n                    .call(chart)
\n                    .call(pointer);
\n
\n                // Zoom goes nuts if you re-use an instance and also can\"t set
\n                // the scale on zoom until it\"s been initialised by chart.
\n        var zoom = d3.behavior.zoom()
\n                    .on(\"zoom\", function() {
\n                      event.zoom.call(this, xScale.domain());
\n                    })
\n                    .x(xScale);
\n
\n        container.call(zoom);
\n      });
\n    }
\n
\n    d3.rebind(mainChart, event, \"on\");
\n
\n    return mainChart;
\n  };
\n
\n  example.barSeries = function() {
\n
\n    var base = fc.series.xyBase();
\n
\n    var bar = fc.svg.bar()
\n            .verticalAlign(\"top\")
\n            .x(base.x)
\n            .height(function(d) { return base.y(d) - base.y0(d); })
\n            .y(base.y0);
\n
\n    var fractionalBarWidth = fc.util.fractionalBarWidth(0.75);
\n
\n    var dataJoin = fc.util.dataJoin()
\n            .selector(\"path\")
\n            .element(\"path\");
\n
\n    function barSeries(selection) {
\n      selection.each(function(data) {
\n        data = data.filter(base.defined);
\n
\n        bar.width(fractionalBarWidth(data.map(base.x)));
\n
\n        dataJoin(this, [data])
\n                    .attr({
\n                      \"d\": bar,
\n                      \"class\": \"bar\"
\n                    });
\n      });
\n    }
\n
\n    d3.rebind(barSeries, base, \"xScale\", \"yScale\", \"xValue\", \"yValue\", \"y0Value\");
\n
\n    return barSeries;
\n  };
\n
\n  example.volumeChart = function() {
\n
\n    var event = d3.dispatch(\"crosshair\");
\n
\n    var chart = fc.chart.cartesian(fc.scale.dateTime())
\n            .margin({
\n              bottom: 20,
\n              right: 60
\n            })
\n            .yTicks(2);
\n
\n    var gridlines = fc.annotation.gridline()
\n            .yTicks(2);
\n
\n    var bar = example.barSeries()
\n            .xValue(function(d) { return d.date; })
\n            .yValue(function(d) { return d.volume; });
\n
\n    var crosshairs = fc.tool.crosshair()
\n            .xLabel(\"\")
\n            .yLabel(\"\");
\n
\n    var multi = fc.series.multi()
\n            .series([gridlines, bar, crosshairs])
\n            .mapping(function(series) {
\n              switch (series) {
\n              case crosshairs:
\n                return this.crosshairs;
\n              default:
\n                return this;
\n              }
\n            });
\n    chart.plotArea(multi);
\n
\n    var pointer = fc.behavior.pointer()
\n            .on(\"point\", event.crosshair);
\n
\n    function volumeChart(selection) {
\n
\n      selection.each(function(data) {
\n
\n        chart.xDomain(data.dateDomain)
\n                    .yDomain(fc.util.extent().fields([\"volume\"])(data))
\n                    .yNice();
\n
\n        bar.y0Value(chart.yDomain()[0]);
\n
\n        var snap = fc.util.seriesPointSnapXOnly(bar, data);
\n
\n        pointer.on(\"point\", function(points) {
\n          event.crosshair(points.map(snap));
\n        });
\n
\n        d3.select(this)
\n                    .call(chart)
\n                    .call(pointer);
\n      });
\n    }
\n
\n    d3.rebind(volumeChart, event, \"on\");
\n
\n    return volumeChart;
\n  };
\n
\n  example.navigatorChart = function() {
\n    var event = d3.dispatch(\"brush\");
\n
\n    var chart = fc.chart.cartesian(fc.scale.dateTime())
\n            .margin({
\n              top: 10,
\n              bottom: 20,
\n              right: 60
\n            })
\n            .xTicks(3)
\n            .yTicks(0);
\n
\n    var gridlines = fc.annotation.gridline()
\n            .xTicks(3)
\n            .yTicks(0);
\n
\n    var area = fc.series.area()
\n            .xValue(function(d) { return d.date; })
\n            .yValue(function(d) { return d.close; })
\n            .decorate(function(sel) {
\n              sel.enter().style({fill: \"#9cf\"});
\n            });
\n
\n    var line = fc.series.line()
\n            .xValue(function(d) { return d.date; })
\n            .yValue(function(d) { return d.close; })
\n            .decorate(function(sel) {
\n              sel.enter().style({stroke: \"#06c\"});
\n            });
\n
\n        // the brush causes a partial render which can glitch things
\n    var brush = d3.svg.brush()
\n            .on(\"brush\", function() {
\n              var domain = [brush.extent()[0][0], brush.extent()[1][0]];
\n                // Scales with a domain delta of 0 === NaN
\n              if (domain[0] - domain[1] !== 0) {
\n                event.brush.call(this, domain);
\n              }
\n            });
\n
\n    var multi = fc.series.multi()
\n            .series([gridlines, area, line, brush])
\n            .mapping(function(series) {
\n                // Need to set the extent AFTER the scales
\n                // are set AND their ranges defined
\n              if (series === brush) {
\n                    // Use chart.yDomain to include `nice` adjustments
\n                brush.extent([
\n                        [this.dateDomain[0], chart.yDomain()[0]],
\n                        [this.dateDomain[1], chart.yDomain()[1]]
\n                ]);
\n              }
\n              return this;
\n            })
\n            .decorate(function(sel) {
\n              var height = d3.select(sel.node().parentNode).layout(\"height\");
\n              sel.enter()
\n                    .selectAll(\".resize.e>rect, .resize.w>rect\")
\n                    .style(\"visibility\", \"visible\")
\n                    .attr(\"y\", height / 4)
\n                    .attr(\"rx\", 4)
\n                    .attr(\"ry\", 4);
\n
\n                // As a y scale is set on the brush (multi does this),
\n                // the brush component resets the height of the rect on every redraw,
\n                // as such it has to be overridden within the update selection,
\n                // rather than the enter selection
\n              sel.selectAll(\".resize.e>rect, .resize.w>rect\")
\n                    .attr(\"height\", height / 2);
\n            });
\n
\n    chart.plotArea(multi);
\n
\n    function navigatorChart(selection) {
\n
\n      selection.each(function(data) {
\n
\n        chart.xDomain(data.navigatorDateDomain)
\n                    .yDomain(data.navigatorYDomain)
\n                    .yNice();
\n
\n        area.y0Value(chart.yDomain()[0]);
\n
\n        d3.select(this)
\n                  .call(chart);
\n      });
\n    }
\n
\n    d3.rebind(navigatorChart, event, \"on\");
\n
\n    return navigatorChart;
\n  };
\n
\n  example.lowBarrel = function() {
\n    var event = d3.dispatch(\"navigate\", \"crosshair\");
\n
\n    var bisector = d3.bisector(function(d) { return d.date; });
\n
\n    var mainChart = example.mainChart()
\n            .on(\"crosshair\", event.crosshair)
\n            .on(\"zoom\", event.navigate);
\n
\n    var volumeChart = example.volumeChart()
\n            .on(\"crosshair\", event.crosshair);
\n
\n    var navigatorChart = example.navigatorChart()
\n            .on(\"brush\", event.navigate);
\n
\n    function lowBarrel(selection) {
\n
\n      selection.each(function(data) {
\n                // Calculate visible data for main/volume charts
\n        var visibleData = data.slice(
\n                    // Pad and clamp the bisector values to ensure extents can be calculated
\n                    Math.max(0, bisector.left(data, data.dateDomain[0]) - 1),
\n                    Math.min(bisector.right(data, data.dateDomain[1]) + 1, data.length)
\n                );
\n        visibleData.dateDomain = data.dateDomain;
\n        visibleData.crosshairs = data.crosshairs;
\n
\n        var container = d3.select(this);
\n
\n        container.select(\"svg.main\")
\n                    .datum(visibleData)
\n                    .call(mainChart);
\n
\n        container.select(\"svg.volume\")
\n                    .datum(visibleData)
\n                    .call(volumeChart);
\n
\n        container.select(\"svg.navigator\")
\n                    .datum(data)
\n                    .call(navigatorChart);
\n      });
\n    }
\n
\n    d3.rebind(lowBarrel, event, \"on\");
\n
\n    return lowBarrel;
\n  };
\n
\n    // Wrap in function to demonstrate no global access to state variables
\n  (function() {
\n    var data = fc.data.random.financial()
\n            .startDate(new Date(2014, 1, 1))(250);
\n
\n        // Enhance data with interactive state
\n    data.crosshairs = [];
\n    var maxDate = fc.util.extent().fields([\"date\"])(data)[1];
\n    var minDate = new Date(maxDate - 50 * 24 * 60 * 60 * 1000);
\n    data.dateDomain = [minDate, maxDate];
\n    data.navigatorDateDomain = fc.util.extent().fields([\"date\"])(data);
\n    data.navigatorYDomain = fc.util.extent().fields([\"close\"])(data);
\n
\n    var container = d3.select(\"#low-barrel\")
\n            .layout();
\n
\n    var render = fc.util.render(function() {
\n      container.datum(data)
\n                .call(lowBarrel);
\n    });
\n
\n    var lowBarrel = example.lowBarrel()
\n            .on(\"crosshair\", function(points) {
\n              data.crosshairs = points;
\n              render();
\n            })
\n            .on(\"navigate\", function(domain) {
\n              data.dateDomain = [
\n                new Date(Math.max(domain[0], data.navigatorDateDomain[0])),
\n                new Date(Math.min(domain[1], data.navigatorDateDomain[1]))
\n              ];
\n              render();
\n            });
\n
\n    render();
\n  }());
\n
\n}(d3, fc, {}));
\n",
        "css": ".chart {
\n  margin: 10px 0;
\n  width: 100%;
\n  height: 250px;
\n}
\n
\n.chart &gt; svg {
\n  margin-left: auto;
\n  margin-right: auto;
\n}
\n
\n.chart.large {
\n  height: 400px;
\n}
\n#low-barrel {
\n  margin: 20px auto;
\n  width: 100%;
\n  height: 400px;
\n  shape-rendering: crispEdges;
\n  pointer-events: all;
\n}
\n
\nrect.background {
\n    fill: none;
\n    stroke: #C0C0C0;
\n}
\nrect.extent {
\n    fill: rgba(128, 179, 236, 0.3);
\n    stroke: #C0C0C0;
\n    stroke-width: 1px;
\n}
\n.resize>rect {
\n    fill: #435862;
\n    stroke: #C0C0C0;
\n    stroke-width: 1px;
\n    shape-rendering: auto;
\n}
\n.tooltip .cell {
\n    font: 10px sans-serif;
\n}
\n.rectangle .container rect {
\n    fill: rgba(249, 249, 249, 0.85);
\n    stroke: rgba(124, 181, 236, 1);
\n    stroke-width: 1px;
\n}
\n
\n.candlestick {
\n  stroke: #000;
\n}
\n
\n.candlestick.up {
\n  fill: #6c0;
\n}
\n
\n.candlestick.down {
\n  fill: #c60;
\n}
\n
\n.bar {
\n  stroke: #06c;
\n  fill: #9cf;
\n}
\n
\n.area, .line {
\n  shape-rendering: auto;
\n}
\n",
        "js_external": "https://d3fc.io/d3fc.bundle.js",
        "css_external": "https://d3fc.io/d3fc.css"}
      '/>
    <input type="submit" class="btn btn-default" value="Codepen"/>
  </form>
</div>


<style>
#low-barrel {
  margin: 20px auto;
  width: 100%;
  height: 400px;
  shape-rendering: crispEdges;
  pointer-events: all;
}

rect.background {
    fill: none;
    stroke: #C0C0C0;
}
rect.extent {
    fill: rgba(128, 179, 236, 0.3);
    stroke: #C0C0C0;
    stroke-width: 1px;
}
.resize>rect {
    fill: #435862;
    stroke: #C0C0C0;
    stroke-width: 1px;
    shape-rendering: auto;
}
.tooltip .cell {
    font: 10px sans-serif;
}
.rectangle .container rect {
    fill: rgba(249, 249, 249, 0.85);
    stroke: rgba(124, 181, 236, 1);
    stroke-width: 1px;
}

.candlestick {
  stroke: #000;
}

.candlestick.up {
  fill: #6c0;
}

.candlestick.down {
  fill: #c60;
}

.bar {
  stroke: #06c;
  fill: #9cf;
}

.area, .line {
  shape-rendering: auto;
}

</style>

<svg id="low-barrel">
  <g layout-style="flex: 0.65; flexDirection: row">
    <svg class="main" layout-style="flex: 1"></svg>
    <g layout-style="width: 20; justifyContent: center">
      <g layout-style="height: 0">
        <text text-anchor="middle" transform="rotate(90)">OHLC</text>
      </g>
    </g>
  </g>
  <g layout-style="flex: 0.2; flexDirection: row">
    <svg class="volume" layout-style="flex: 1"></svg>
    <g layout-style="width: 20; justifyContent: center">
      <g layout-style="height: 0">
        <text text-anchor="middle" transform="rotate(90)">Volume</text>
      </g>
    </g>
  </g>
  <g layout-style="flex: 0.15; flexDirection: row">
    <svg class="navigator" layout-style="flex: 1"></svg>
    <text layout-style="width: 20"></text>
  </g>
</svg>


<script>
(function() {
    function render() {
        /* global d3:false, fc:false */
(function(d3, fc, example) {
  'use strict';

  var formatters = {
    date: d3.time.format('%A, %b %e, %Y'),
    price: d3.format('.2f'),
    volume: d3.format('0,5p')
  };

  example.candlestickSeries = function() {

    var base = fc.series.ohlcBase();

    var candlestick = fc.svg.candlestick()
            .x(function(d) { return d.x; })
            .open(function(d) { return d.yOpen; })
            .high(function(d) { return d.yHigh; })
            .low(function(d) { return d.yLow; })
            .close(function(d) { return d.yClose; });

    var nest = d3.nest()
            .key(function(d) { return d.direction; });

    var dataJoin = fc.util.dataJoin()
            .selector('path')
            .element('path');

    function candlestickSeries(selection) {
      selection.each(function(data) {
        data = data.filter(base.defined);

        candlestick.width(base.width(data));

        dataJoin(this, nest.entries(data.map(base.values)))
                    .attr({
                      'd': function(d) {
                        return candlestick(d.values);
                      },
                      'class': function(d) {
                        return 'candlestick ' + d.key;
                      }
                    });
      });
    }

    d3.rebind(candlestickSeries, base, 'xScale', 'yScale', 'xValue', 'yValue');

    return candlestickSeries;
  };

  example.mainChart = function() {

    var event = d3.dispatch('crosshair', 'zoom');

    var gridlines = fc.annotation.gridline()
            .yTicks(3);

    var candlestick = example.candlestickSeries();

    var tooltip = fc.chart.tooltip()
            .items([
                [function(d) { return formatters.date(d.datum.date); }, ''],
                ['High:', function(d) { return formatters.price(d.datum.high); }],
                ['Low:', function(d) { return formatters.price(d.datum.low); }],
                ['Open:', function(d) { return formatters.price(d.datum.open); }],
                ['Close:', function(d) { return formatters.price(d.datum.close); }],
                ['Volume:', function(d) { return formatters.volume(d.datum.volume); }]
            ]);

    var tooltipContainer = fc.tool.container()
            .padding(5)
            .component(tooltip);

    var tooltipLayout = fc.layout.label(fc.layout.strategy.boundingBox())
            .size([150, 104])
            .component(tooltipContainer);

    var crosshairs = fc.tool.crosshair()
            .xLabel('')
            .yLabel('');

    var multi = fc.series.multi()
            .series([gridlines, candlestick, tooltipLayout, crosshairs])
            .mapping(function(series) {
              switch (series) {
              case crosshairs:
              case tooltipLayout:
                return this.crosshairs;
              default:
                return this;
              }
            });

    var xScale = fc.scale.dateTime();

    var chart = fc.chart.cartesian(xScale)
            .margin({
              bottom: 20,
              right: 60
            })
            .xTicks(0)
            .yTicks(3)
            .plotArea(multi);

    var pointer = fc.behavior.pointer();

    function mainChart(selection) {

      selection.each(function(data) {
        var snap = fc.util.seriesPointSnapXOnly(candlestick, data);

        pointer.on('point', function(points) {
          event.crosshair(points.map(snap));
        });

        chart.xDomain(data.dateDomain)
                    .yDomain(fc.util.extent().fields(['high', 'low'])(data))
                    .yNice();

        var container = d3.select(this)
                    .call(chart)
                    .call(pointer);

                // Zoom goes nuts if you re-use an instance and also can't set
                // the scale on zoom until it's been initialised by chart.
        var zoom = d3.behavior.zoom()
                    .on('zoom', function() {
                      event.zoom.call(this, xScale.domain());
                    })
                    .x(xScale);

        container.call(zoom);
      });
    }

    d3.rebind(mainChart, event, 'on');

    return mainChart;
  };

  example.barSeries = function() {

    var base = fc.series.xyBase();

    var bar = fc.svg.bar()
            .verticalAlign('top')
            .x(base.x)
            .height(function(d) { return base.y(d) - base.y0(d); })
            .y(base.y0);

    var fractionalBarWidth = fc.util.fractionalBarWidth(0.75);

    var dataJoin = fc.util.dataJoin()
            .selector('path')
            .element('path');

    function barSeries(selection) {
      selection.each(function(data) {
        data = data.filter(base.defined);

        bar.width(fractionalBarWidth(data.map(base.x)));

        dataJoin(this, [data])
                    .attr({
                      'd': bar,
                      'class': 'bar'
                    });
      });
    }

    d3.rebind(barSeries, base, 'xScale', 'yScale', 'xValue', 'yValue', 'y0Value');

    return barSeries;
  };

  example.volumeChart = function() {

    var event = d3.dispatch('crosshair');

    var chart = fc.chart.cartesian(fc.scale.dateTime())
            .margin({
              bottom: 20,
              right: 60
            })
            .yTicks(2);

    var gridlines = fc.annotation.gridline()
            .yTicks(2);

    var bar = example.barSeries()
            .xValue(function(d) { return d.date; })
            .yValue(function(d) { return d.volume; });

    var crosshairs = fc.tool.crosshair()
            .xLabel('')
            .yLabel('');

    var multi = fc.series.multi()
            .series([gridlines, bar, crosshairs])
            .mapping(function(series) {
              switch (series) {
              case crosshairs:
                return this.crosshairs;
              default:
                return this;
              }
            });
    chart.plotArea(multi);

    var pointer = fc.behavior.pointer()
            .on('point', event.crosshair);

    function volumeChart(selection) {

      selection.each(function(data) {

        chart.xDomain(data.dateDomain)
                    .yDomain(fc.util.extent().fields(['volume'])(data))
                    .yNice();

        bar.y0Value(chart.yDomain()[0]);

        var snap = fc.util.seriesPointSnapXOnly(bar, data);

        pointer.on('point', function(points) {
          event.crosshair(points.map(snap));
        });

        d3.select(this)
                    .call(chart)
                    .call(pointer);
      });
    }

    d3.rebind(volumeChart, event, 'on');

    return volumeChart;
  };

  example.navigatorChart = function() {
    var event = d3.dispatch('brush');

    var chart = fc.chart.cartesian(fc.scale.dateTime())
            .margin({
              top: 10,
              bottom: 20,
              right: 60
            })
            .xTicks(3)
            .yTicks(0);

    var gridlines = fc.annotation.gridline()
            .xTicks(3)
            .yTicks(0);

    var area = fc.series.area()
            .xValue(function(d) { return d.date; })
            .yValue(function(d) { return d.close; })
            .decorate(function(sel) {
              sel.enter().style({fill: '#9cf'});
            });

    var line = fc.series.line()
            .xValue(function(d) { return d.date; })
            .yValue(function(d) { return d.close; })
            .decorate(function(sel) {
              sel.enter().style({stroke: '#06c'});
            });

        // the brush causes a partial render which can glitch things
    var brush = d3.svg.brush()
            .on('brush', function() {
              var domain = [brush.extent()[0][0], brush.extent()[1][0]];
                // Scales with a domain delta of 0 === NaN
              if (domain[0] - domain[1] !== 0) {
                event.brush.call(this, domain);
              }
            });

    var multi = fc.series.multi()
            .series([gridlines, area, line, brush])
            .mapping(function(series) {
                // Need to set the extent AFTER the scales
                // are set AND their ranges defined
              if (series === brush) {
                    // Use chart.yDomain to include `nice` adjustments
                brush.extent([
                        [this.dateDomain[0], chart.yDomain()[0]],
                        [this.dateDomain[1], chart.yDomain()[1]]
                ]);
              }
              return this;
            })
            .decorate(function(sel) {
              var height = d3.select(sel.node().parentNode).layout('height');
              sel.enter()
                    .selectAll('.resize.e>rect, .resize.w>rect')
                    .style('visibility', 'visible')
                    .attr('y', height / 4)
                    .attr('rx', 4)
                    .attr('ry', 4);

                // As a y scale is set on the brush (multi does this),
                // the brush component resets the height of the rect on every redraw,
                // as such it has to be overridden within the update selection,
                // rather than the enter selection
              sel.selectAll('.resize.e>rect, .resize.w>rect')
                    .attr('height', height / 2);
            });

    chart.plotArea(multi);

    function navigatorChart(selection) {

      selection.each(function(data) {

        chart.xDomain(data.navigatorDateDomain)
                    .yDomain(data.navigatorYDomain)
                    .yNice();

        area.y0Value(chart.yDomain()[0]);

        d3.select(this)
                  .call(chart);
      });
    }

    d3.rebind(navigatorChart, event, 'on');

    return navigatorChart;
  };

  example.lowBarrel = function() {
    var event = d3.dispatch('navigate', 'crosshair');

    var bisector = d3.bisector(function(d) { return d.date; });

    var mainChart = example.mainChart()
            .on('crosshair', event.crosshair)
            .on('zoom', event.navigate);

    var volumeChart = example.volumeChart()
            .on('crosshair', event.crosshair);

    var navigatorChart = example.navigatorChart()
            .on('brush', event.navigate);

    function lowBarrel(selection) {

      selection.each(function(data) {
                // Calculate visible data for main/volume charts
        var visibleData = data.slice(
                    // Pad and clamp the bisector values to ensure extents can be calculated
                    Math.max(0, bisector.left(data, data.dateDomain[0]) - 1),
                    Math.min(bisector.right(data, data.dateDomain[1]) + 1, data.length)
                );
        visibleData.dateDomain = data.dateDomain;
        visibleData.crosshairs = data.crosshairs;

        var container = d3.select(this);

        container.select('svg.main')
                    .datum(visibleData)
                    .call(mainChart);

        container.select('svg.volume')
                    .datum(visibleData)
                    .call(volumeChart);

        container.select('svg.navigator')
                    .datum(data)
                    .call(navigatorChart);
      });
    }

    d3.rebind(lowBarrel, event, 'on');

    return lowBarrel;
  };

    // Wrap in function to demonstrate no global access to state variables
  (function() {
    var data = fc.data.random.financial()
            .startDate(new Date(2014, 1, 1))(250);

        // Enhance data with interactive state
    data.crosshairs = [];
    var maxDate = fc.util.extent().fields(['date'])(data)[1];
    var minDate = new Date(maxDate - 50 * 24 * 60 * 60 * 1000);
    data.dateDomain = [minDate, maxDate];
    data.navigatorDateDomain = fc.util.extent().fields(['date'])(data);
    data.navigatorYDomain = fc.util.extent().fields(['close'])(data);

    var container = d3.select('#low-barrel')
            .layout();

    var render = fc.util.render(function() {
      container.datum(data)
                .call(lowBarrel);
    });

    var lowBarrel = example.lowBarrel()
            .on('crosshair', function(points) {
              data.crosshairs = points;
              render();
            })
            .on('navigate', function(domain) {
              data.dateDomain = [
                new Date(Math.max(domain[0], data.navigatorDateDomain[0])),
                new Date(Math.min(domain[1], data.navigatorDateDomain[1]))
              ];
              render();
            });

    render();
  }());

}(d3, fc, {}));

    }
    render();
    $(window).resize(fc.util.render(render));
})();
</script>


<p>This example shows how a more complex chart can be built using the d3fc components.</p>
<p>The three charts that make up this example are each <a href="/components/chart/cartesian.html">cartesian charts</a>. The top-most chart uses the <a href="/components/annotation/gridlines.html">gridlines</a>, <a href="/components/tool/crosshair.html">crosshairs</a> and <a href="/components/series/candlestick.html">candlestick</a> components, rendered via the <a href="/components/series/multi.html">multi-series</a> component. The volume and navigator charts uses a similar mix of components.</p>
<p>These charts all share the same underlying data, however, this is enhanced with the data that represents the current interactive state.</p>
<p>The top-most chart uses a tooltip component that is added as a &#39;decoration&#39; of the crosshair.</p>

    </div>

    <nav class="col-sm-3 hidden-xs">
      <ul class="nav nav-stacked fixed nav-sidebar">
        <li>
          <h4>Examples</h4>
          <ul class="nav nav-stacked">
                <li class="">
                  <a href="/examples/area-line-point/index.html">Area Line Point</a>
                </li>
                <li class="">
                  <a href="/examples/bubble/index.html">Bubble Chart</a>
                </li>
                <li class="active">
                  <a href="/examples/low-barrel/index.html">Low Barrel</a>
                </li>
                <li class="">
                  <a href="/examples/multi-line/index.html">Multi Line</a>
                </li>
                <li class="">
                  <a href="/examples/scatter/index.html">Scatterplot</a>
                </li>
                <li class="">
                  <a href="/examples/simple/index.html">Line / Area Chart</a>
                </li>
                <li class="">
                  <a href="/examples/stacked/index.html">Stacked Bar</a>
                </li>
                <li class="">
                  <a href="/examples/streaming/index.html">Streaming Chart</a>
                </li>
                <li class="">
                  <a href="/examples/wealth-and-health-of-nations/index.html">The Wealth &amp; Health of Nations</a>
                </li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>

</div>


    </div>
    <footer>
      <div class="container">
        <p class="muted credit text-center">Project supported by <a href="http://www.scottlogic.com">Scott Logic</a>.</p>
        <p class="muted credit text-center">Browser testing provided by <a class="browserstack" href="https://browserstack.com">BrowserStack</a>.</p>
      </div>
    </footer>

      <script src="//localhost:35729/livereload.js"></script>
  </body>
</html>
